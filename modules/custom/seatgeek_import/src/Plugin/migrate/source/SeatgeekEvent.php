<?php

namespace Drupal\seatgeek_import\Plugin\migrate\source;

use Drupal\migrate_plus\Plugin\migrate\source\Url;
use Drupal\migrate\Row;
use Drupal\taxonomy\Entity\Term;
use Drupal\migrate\Plugin\MigrationInterface;

/**
 * Source plugin for events.
 *
 * @MigrateSource(
 *   id = "seatgeek_event"
 * )
 */
class SeatgeekEvent extends Url {

  /**
   * The source URLs to retrieve.
   *
   * @var array
   */
  protected $sourceUrls = [];
  
  private $endpoint;
  
  /**
   * {@inheritdoc}
   */
  public function __construct(array $configuration, $plugin_id, $plugin_definition, MigrationInterface $migration) {
    
    // Override URL with endpoint set in config form
    $config = \Drupal::service('config.factory')->get('seatgeek_import.settings');
    //$user = $config->get('seatgeek_import_client');    
    //$endpoint = 'https://system.seatgeek.com/' . $user . '/api/v1/eventsrestful.svc/allattributes/next?n=1000';
    $endpoint = $config->get('seatgeek_import_feed_url');
    
    $configuration['urls'] = $endpoint;
    
    if (!is_array($configuration['urls'])) {
      $configuration['urls'] = [$configuration['urls']];
    }
    parent::__construct($configuration, $plugin_id, $plugin_definition, $migration);

    $this->endpoint = $endpoint;
    $this->sourceUrls = $configuration['urls'];
  }
  
  /**
   * {@inheritdoc}
   */
  public function fields() {
	$fields = [];
	foreach ($this->fields as $field_info) {
	  $fields[$field_info['name']] = isset($field_info['label']) ? $field_info['label'] : $field_info['name'];
	}
	return $fields;
  }

  /**
   * {@inheritdoc}
   */
  public function getIds() {
	return [
	  'event_id' => [
		'type' => 'string',
        'length'  =>  255,  
		'alias' => 'p',
	  ],
	];
  }

  /**
   * {@inheritdoc}
   */
  public function prepareRow(Row $row) {
   
    // Set venue
    //$events = $row->getSourceProperty('venue');
    
//    var_dump($row);die;
    
//    foreach ($events as $event) {
//      
//      if (isset($event->HallName)) {
//        $row->setSourceProperty('venue', (string)$event->HallName);
//        break;
//      }
//      else { // Couldn't fetch hallname from performance, reload data from API
//        
//        $config = \Drupal::service('config.factory')->get('seatgeek_import.settings');
//        $event_id = $row->getSourceProperty('event_id');
//        $client = \Drupal::httpClient();
//        $response = $client->get($config->get('seatgeek_import_domain') .'/feed/events/?showid=' . $event_id);
//        if ($xml = $response->getBody()->getContents()) {
//          $document = new \DOMDocument();
//          $document->loadXml($xml);
//          $xpath = new \DOMXpath($document);                
//          $venue = $xpath->evaluate('string(Events/Event/HallName)');
//          $row->setSourceProperty('venue', $venue);
//        }
//      }
//    }
    
	// Try and grab genre, venue and price
	if ($attrs = json_decode(json_encode($row->getSourceProperty('Attributes')))) {
      
      if (!empty($attrs) && isset($attrs->EventAttribute)) {
        
        foreach ($attrs->EventAttribute as $attr) {
         
          if (!empty($attr->Value)) {
            // Check 'exclude' flag
            if ($attr->Name == 'Exclude from Website') {			  
              if ($attr->Value == 1) {
                return FALSE;
              }
            }
            // Set appropriate source field value            
            switch ($attr->Name) {
              case "Price":
                $row->setSourceProperty('price', $attr->Value);
                break;

              case "Genre": // Parent term needs to be mapped

//                // Try and load matching taxonomy term first
//                $term = \Drupal::entityTypeManager()
//                    ->getStorage('taxonomy_term')
//                    ->loadByProperties(['name' => $attr->Value]);			  
//                if ($term) { // Only set if term found
//                  $term = array_pop($term);				  
//                  // Try and load parent tid
//                  $parent = \Drupal::entityTypeManager()->getStorage('taxonomy_term')->loadParents($term->id());
//                  if ($parent) {
//                    $parent = reset($parent);
//                    $tid = $parent->id();
//                  }
//                  else { // No parent, return term ID
//                    $tid = $term->id();
//                  }				  
//                  $row->setSourceProperty('genre', $tid);				  
//                }			
                break;

//              case "Venue":
//              case "Location": 
//                if (!empty($attr->Value) && is_string($attr->Value)) {                  
//                  // Try and load matching venue node
//                  $nodes = \Drupal::entityTypeManager()
//                    ->getStorage('node')
//                    ->loadByProperties(['title' => $attr->Value]);
//
//                  if ($node = reset($nodes)) {
//                    $row->setSourceProperty('venue', $node);
//                  }                  
//                }
//                else {
//                  var_dump($attr);
//                }
//                break;
            }
          }          
        }        
	  }
	}
	return parent::prepareRow($row);
  }

}
